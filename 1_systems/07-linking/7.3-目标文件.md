

---

# 目标文件类型详解（基于 ELF 格式）

## 一、三种目标文件类型概述

| 文件类型                    | 中文名称          | 主要用途                     | 是否可执行    | 是否需链接    |
| ----------------------- | ------------- | ------------------------ | -------- | -------- |
| Relocatable Object File | 可重定位目标文件      | 编译生成的中间文件，用于链接成可执行文件或共享库 | 否        | 是        |
| Executable Object File  | 可执行目标文件       | 链接完成后的程序，可直接由操作系统加载执行    | 是        | 否        |
| Shared Object File      | 共享目标文件（动态链接库） | 在运行时由动态链接器加载             | 否（可间接执行） | 是（运行时链接） |

---

## 二、ELF 文件结构简介

ELF 文件大致分为两种视图：

* **链接视图（Linking View）**：关注 `Section`（节区），用于编译、链接。
* **执行视图（Execution View）**：关注 `Segment`（程序头部 Program Header），用于加载执行。

### ELF Header（ELF 头）

位于文件开头，包含以下信息：

* 魔数（Magic Number）
* 文件类型（ET\_REL, ET\_EXEC, ET\_DYN）
* 目标架构（如 x86\_64）
* 条目点地址（Entry Point）
* 节区头表偏移（e\_shoff）
* 程序头表偏移（e\_phoff）

---

## 三、Section（节）详解

以下为 ELF 文件中常见的 Section，以及它们在三种目标文件中的作用对比：

| Section 名称                 | 作用                         | Relocatable | Executable | Shared |
| -------------------------- | -------------------------- | ----------- | ---------- | ------ |
| `.text`                    | 存放代码段                      | ✅           | ✅          | ✅      |
| `.data`                    | 初始化的全局/静态变量                | ✅           | ✅          | ✅      |
| `.bss`                     | 未初始化的全局/静态变量               | ✅           | ✅          | ✅      |
| `.rodata`                  | 只读数据，如字符串常量                | ✅           | ✅          | ✅      |
| `.symtab`                  | 符号表（调试用）                   | ✅           | ❌          | ✅（可选）  |
| `.strtab`                  | 字符串表，存储符号名                 | ✅           | ❌          | ✅（可选）  |
| `.rel.text` 或 `.rela.text` | 存储 `.text` 节中的重定位信息        | ✅           | ❌          | ❌      |
| `.debug*`                  | 调试信息                       | ✅           | ❌          | ✅（可选）  |
| `.plt`                     | 用于延迟绑定函数调用（仅动态链接中使用）       | ❌           | ✅          | ✅      |
| `.got`                     | 全局偏移表（Global Offset Table） | ❌           | ✅          | ✅      |
| `.init` / `.fini`          | 程序初始化 / 清理代码段              | ❌           | ✅          | ✅      |

---

## 四、三种文件的 ELF 格式差异

### 1. **Relocatable Object File（`.o` 文件）**

* **类型标识**：`ET_REL`
* **用途**：作为链接器输入，组合生成可执行或共享对象文件
* **节（Section）为主**，不含段（Segment）
* 包含重定位信息 `.rel.*` 或 `.rela.*`
* 通常包括符号表 `.symtab` 和字符串表 `.strtab`

**结构特点**：

* 无程序头（Program Header Table）
* 未设置执行入口点（Entry Point 为 0）

---

### 2. **Executable Object File（可执行文件）**

* **类型标识**：`ET_EXEC`
* **用途**：操作系统加载并运行
* **包含段（Segment）为主**，便于操作系统加载
* 重定位已完成，符号解析完毕
* 不包含 `.rel.*` 重定位节和 `.symtab` 符号表

**结构特点**：

* 有程序头（Program Header Table）
* 包含入口点（Entry Point）
* 通常剥离了调试信息（strip）

---

### 3. **Shared Object File（共享库，如 `.so`）**

* **类型标识**：`ET_DYN`
* **用途**：运行时由动态链接器加载，可作为可执行或共享目标
* 结构与可执行文件相似，但地址位置是**位置无关的（PIC）**
* 包含用于动态链接的 `.got`, `.plt`, `.dynamic`, `.dynsym` 等节

**结构特点**：

* 具备程序头（Program Header Table）
* 没有固定入口点，供主程序调用
* 支持运行时链接和符号重定位

---

## 五、图示：三种 ELF 类型结构对比

```text
+----------------------+      +----------------------+      +----------------------+
| ELF Header           |      | ELF Header           |      | ELF Header           |
+----------------------+      +----------------------+      +----------------------+
| Section Header Table |      | Program Header Table |      | Program Header Table |
+----------------------+      +----------------------+      +----------------------+
| .text / .data / ...  |      | Segments (LOAD)      |      | Segments (LOAD)      |
| .rel.text / .symtab  |      | .text, .data         |      | .text, .data, .plt   |
+----------------------+      +----------------------+      +----------------------+
| Debug Sections       |      |                       |      | .dynamic, .dynsym    |
+----------------------+      +----------------------+      +----------------------+
| No Entry Point       |      | Entry Point Present  |      | PIC Code             |
+----------------------+      +----------------------+      +----------------------+
| ET_REL               |      | ET_EXEC              |      | ET_DYN               |
+----------------------+      +----------------------+      +----------------------+
```

---

## 六、总结对比表

| 特性             | Relocatable (`.o`) | Executable    | Shared Object (`.so`) |
| -------------- | ------------------ | ------------- | --------------------- |
| 文件类型标识         | `ET_REL`           | `ET_EXEC`     | `ET_DYN`              |
| 是否可执行          | 否                  | 是             | 否（间接）                 |
| 是否包含重定位信息      | ✅                  | ❌             | ✅（延迟绑定）               |
| 是否包含符号表        | ✅                  | ❌（一般被剥离）      | ✅（用于动态链接）             |
| 是否包含段（Segment） | ❌                  | ✅             | ✅                     |
| 是否位置无关         | ❌                  | ❌（通常固定地址）     | ✅                     |
| 动态链接功能         | ❌                  | ✅（如果使用 `.so`） | ✅                     |

---

