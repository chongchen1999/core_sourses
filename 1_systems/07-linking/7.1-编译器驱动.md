# C/C++ 从源代码到运行全过程

C/C++ 程序从源代码变成可以运行的程序，通常要经历以下几个主要阶段：

1. 预处理（Preprocessing）
2. 编译（Compilation）
3. 汇编（Assembly）
4. 链接（Linking）
5. 加载与运行（Loading & Execution）

---

## 🧩 1. 预处理（Preprocessing）

**工具：** C Preprocessor（如 `cpp`）

**输入：** `.c` 或 `.cpp` 源文件
**输出：** 预处理后的代码（通常是临时 `.i` 或 `.ii` 文件）

**主要任务：**

* 处理 `#include` 指令，将头文件展开
* 处理 `#define` 宏定义
* 条件编译（如 `#ifdef`, `#ifndef`）
* 删除注释

**示例命令：**

```bash
g++ -E main.cpp -o main.i
```

---

## 🛠️ 2. 编译（Compilation）

**工具：** 编译器前端（如 `g++`）

**输入：** 预处理后的 `.i` 或 `.ii` 文件
**输出：** 汇编语言代码（`.s` 文件）

**主要任务：**

* 将源代码翻译为汇编代码
* 进行语法和语义分析
* 优化代码结构

**示例命令：**

```bash
g++ -S main.i -o main.s
```

---

## ⚙️ 3. 汇编（Assembly）

**工具：** 汇编器（如 `as`）

**输入：** 汇编文件（`.s`）
**输出：** 目标文件（`.o`）

**主要任务：**

* 将汇编代码翻译成机器指令
* 生成可重定位目标代码

**示例命令：**

```bash
g++ -c main.s -o main.o
```

---

## 🔗 4. 链接（Linking）

**工具：** 链接器（如 `ld`）

**输入：** 一个或多个 `.o` 文件，以及库文件
**输出：** 可执行文件（如 `a.out` 或自定义名）

**主要任务：**

* 将多个目标文件合并
* 解析外部符号引用（如函数调用、全局变量）
* 链接静态库或动态库

**示例命令：**

```bash
g++ main.o -o main
```

---

## 🚀 5. 加载与运行（Loading & Execution）

**工具：** 操作系统（如 Linux 的 ELF 加载器）

**输入：** 可执行文件
**输出：** 程序在内存中执行

**主要任务：**

* 将可执行文件加载到内存
* 创建进程地址空间
* 分配堆栈、堆等区域
* 初始化运行环境（如全局变量）
* 跳转到 `main()` 函数开始执行

---

## 总结流程图

```text
main.cpp
   ↓ (预处理)
main.i
   ↓ (编译)
main.s
   ↓ (汇编)
main.o
   ↓ (链接)
main (可执行文件)
   ↓ (加载与执行)
程序运行中...
```

---

## 📝 附注

* 上述过程也适用于 C，但 C++ 多了如类、模板等编译器处理内容。
* 使用 IDE（如 Visual Studio 或 CLion）会自动完成这些步骤。
* 动态链接的程序在运行时还可能涉及运行时链接器（如 `ld-linux.so`）。

